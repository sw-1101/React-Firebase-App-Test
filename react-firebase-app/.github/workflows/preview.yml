name: ğŸ” Preview Deployment

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'

jobs:
  preview:
    name: ğŸŒ Deploy Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    environment:
      name: preview-pr-${{ github.event.number }}
      url: ${{ steps.preview-deploy.outputs.details_url }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build application
      run: npm run build
      env:
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
    
    - name: ğŸŒ Deploy to Firebase Hosting Preview
      id: preview-deploy
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
        expires: 7d
    
    - name: ğŸ’¬ Comment Preview URL
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ')
          );
          
          const previewUrl = '${{ steps.preview-deploy.outputs.details_url }}';
          const commentBody = `## ğŸŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          
**ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${previewUrl}

### ğŸ“‹ ç¢ºèªé …ç›®
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
- [ ] ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

> ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯7æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™`;

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody,
            });
          }