name: ğŸ›¡ï¸ Branch Protection Checks

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'

jobs:
  # å¿…é ˆãƒã‚§ãƒƒã‚¯: TypeScript & ESLint
  static-analysis:
    name: ğŸ“ Static Analysis
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” TypeScript check
      run: npm run type-check
    
    - name: ğŸ§¹ ESLint check
      run: npm run lint

  # å¿…é ˆãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ§ª Run unit tests
      run: npm run test
      env:
        CI: true

  # å¿…é ˆãƒã‚§ãƒƒã‚¯: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
  component-tests:
    name: ğŸ“š Component Tests (Storybook)
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ“š Build Storybook
      run: npm run build-storybook

  # å¿…é ˆãƒã‚§ãƒƒã‚¯: E2Eãƒ†ã‚¹ãƒˆ
  e2e-tests:
    name: ğŸ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build application
      run: npm run build
      env:
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
    
    - name: ğŸ­ Install Playwright
      run: npx playwright install --with-deps chromium
    
    - name: ğŸ­ Run E2E tests
      run: npm run test:e2e -- --project=chromium
      env:
        CI: true
    
    - name: ğŸ“¤ Upload E2E test results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # å¿…é ˆãƒã‚§ãƒƒã‚¯: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ”’ Run security audit
      run: npm audit --audit-level high
      continue-on-error: true
    
    - name: ğŸ” Dependency vulnerability scan
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high

  # ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
  pr-ready:
    name: âœ… PR Ready for Review
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, component-tests, e2e-tests, security-scan]
    if: success()
    steps:
    - name: âœ… All checks passed
      run: |
        echo "ğŸ‰ All required checks have passed!"
        echo "ğŸ“‹ Summary:"
        echo "- âœ… Static Analysis (TypeScript + ESLint)"
        echo "- âœ… Unit Tests"
        echo "- âœ… Component Tests (Storybook)"
        echo "- âœ… E2E Tests (Playwright)"
        echo "- âœ… Security Scan"
        echo ""
        echo "This PR is ready for code review! ğŸš€"
    
    - name: ğŸ’¬ Comment PR status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸ›¡ï¸ Branch Protection')
          );
          
          const commentBody = `## ğŸ›¡ï¸ Branch Protection ãƒã‚§ãƒƒã‚¯å®Œäº†

**âœ… ã™ã¹ã¦ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼**

### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ
- âœ… **Static Analysis**: TypeScriptå‹ãƒã‚§ãƒƒã‚¯ + ESLint
- âœ… **Unit Tests**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- âœ… **Component Tests**: Storybook ãƒ“ãƒ«ãƒ‰
- âœ… **E2E Tests**: Playwright E2Eãƒ†ã‚¹ãƒˆ
- âœ… **Security Scan**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚
ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èªå¾Œã€main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚

> ğŸ”„ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã³ã«ã€ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™`;

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody,
            });
          }