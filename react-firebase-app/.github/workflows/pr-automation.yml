name: ğŸ¤– PR Automation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ©ãƒ™ãƒ«è‡ªå‹•ä»˜ä¸
  pr-labeler:
    name: ğŸ·ï¸ Auto Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ·ï¸ Auto assign labels
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const title = pr.title.toLowerCase();
          const body = pr.body ? pr.body.toLowerCase() : '';
          const labels = [];
          
          // ã‚¿ã‚¤ãƒˆãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ©ãƒ™ãƒ«
          if (title.includes('feat') || title.includes('feature')) {
            labels.push('âœ¨ feature');
          }
          if (title.includes('fix') || title.includes('bug')) {
            labels.push('ğŸ› bug');
          }
          if (title.includes('docs') || title.includes('documentation')) {
            labels.push('ğŸ“š documentation');
          }
          if (title.includes('refactor')) {
            labels.push('â™»ï¸ refactoring');
          }
          if (title.includes('test')) {
            labels.push('ğŸ§ª tests');
          }
          if (title.includes('style') || title.includes('design')) {
            labels.push('ğŸ¨ design');
          }
          if (title.includes('chore') || title.includes('maintenance')) {
            labels.push('ğŸ”§ maintenance');
          }
          
          // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ©ãƒ™ãƒ«
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const fileTypes = files.map(file => file.filename);
          
          if (fileTypes.some(f => f.includes('.github/workflows'))) {
            labels.push('âš™ï¸ ci/cd');
          }
          if (fileTypes.some(f => f.includes('package.json'))) {
            labels.push('ğŸ“¦ dependencies');
          }
          if (fileTypes.some(f => f.includes('.tsx') || f.includes('.ts'))) {
            labels.push('âš›ï¸ react');
          }
          if (fileTypes.some(f => f.includes('.css') || f.includes('.scss'))) {
            labels.push('ğŸ¨ styling');
          }
          if (fileTypes.some(f => f.includes('firebase'))) {
            labels.push('ğŸ”¥ firebase');
          }
          
          // PRã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ã®ãƒ©ãƒ™ãƒ«
          const additions = pr.additions || 0;
          const deletions = pr.deletions || 0;
          const totalChanges = additions + deletions;
          
          if (totalChanges < 50) {
            labels.push('ğŸ“¦ size/XS');
          } else if (totalChanges < 200) {
            labels.push('ğŸ“¦ size/S');
          } else if (totalChanges < 500) {
            labels.push('ğŸ“¦ size/M');
          } else if (totalChanges < 1000) {
            labels.push('ğŸ“¦ size/L');
          } else {
            labels.push('ğŸ“¦ size/XL');
          }
          
          // ãƒ©ãƒ™ãƒ«ä»˜ä¸
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels,
            });
          }

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚µãƒãƒªãƒ¼
  pr-summary:
    name: ğŸ“Š PR Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“Š Generate PR summary
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          // ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´çµ±è¨ˆ
          const fileTypes = {
            'âš›ï¸ React Components': files.filter(f => f.filename.includes('.tsx') && f.filename.includes('components')).length,
            'ğŸ”§ Hooks': files.filter(f => f.filename.includes('hooks/')).length,
            'ğŸ¨ Styles': files.filter(f => f.filename.includes('.css') || f.filename.includes('.scss')).length,
            'ğŸ“š Stories': files.filter(f => f.filename.includes('.stories.')).length,
            'ğŸ­ E2E Tests': files.filter(f => f.filename.includes('e2e/')).length,
            'âš™ï¸ Config': files.filter(f => f.filename.includes('config') || f.filename.includes('.json')).length,
            'ğŸ“– Documentation': files.filter(f => f.filename.includes('.md')).length,
            'ğŸ”„ CI/CD': files.filter(f => f.filename.includes('.github/')).length,
          };
          
          const changedFiles = Object.entries(fileTypes)
            .filter(([, count]) => count > 0)
            .map(([type, count]) => `- ${type}: ${count} files`)
            .join('\n');
          
          const summary = `## ğŸ“Š ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µãƒãƒªãƒ¼

### ğŸ“ˆ å¤‰æ›´çµ±è¨ˆ
- **è¿½åŠ è¡Œæ•°**: +${pr.additions || 0}
- **å‰Šé™¤è¡Œæ•°**: -${pr.deletions || 0}
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${pr.changed_files || 0}
- **ã‚³ãƒŸãƒƒãƒˆæ•°**: ${pr.commits || 0}

### ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—
${changedFiles || 'ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ãªã—'}

### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
${pr.body && pr.body.includes('## ') ? 
  'èª¬æ˜æ–‡ã«è©³ç´°ãªæƒ…å ±ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚' : 
  'âš ï¸ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èª¬æ˜ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚'}

### âœ… è‡ªå‹•ãƒã‚§ãƒƒã‚¯
ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š
- ğŸ” TypeScript & ESLint
- ğŸ§ª Unit Tests
- ğŸ“š Storybook Build
- ğŸ­ E2E Tests (Playwright)
- ğŸ”’ Security Scan

---
*ã“ã®ã‚µãƒãƒªãƒ¼ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ ğŸ¤–*`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: summary,
          });

  # ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èªå¾Œã®è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  post-approval:
    name: ğŸ‰ Post Approval Actions
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
    
    steps:
    - name: ğŸ‰ Approval celebration
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
          });
          
          // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èªæ•°ç¢ºèª
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
          });
          
          const approvedReviews = reviews.filter(review => review.state === 'APPROVED');
          const requiredApprovals = 1; // ãƒ–ãƒ©ãƒ³ãƒä¿è­·è¨­å®šã¨åˆã‚ã›ã‚‹
          
          if (approvedReviews.length >= requiredApprovals) {
            const celebrationComment = `## ğŸ‰ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èªå®Œäº†ï¼

**âœ… å¿…è¦ãªæ‰¿èªæ•°ã«é”ã—ã¾ã—ãŸ (${approvedReviews.length}/${requiredApprovals})**

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ãŒ âœ… ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
2. ç«¶åˆãŒãªã„ã“ã¨ã‚’ç¢ºèª
3. **Squash and merge** ã¾ãŸã¯ **Create a merge commit** ã§ãƒãƒ¼ã‚¸

### ğŸ‘¥ æ‰¿èªè€…
${approvedReviews.map(review => `- @${review.user.login}`).join('\n')}

---
ğŸŠ ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ç´ æ™´ã‚‰ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: celebrationComment,
            });
          }

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†å¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  pr-cleanup:
    name: ğŸ§¹ PR Cleanup
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    
    steps:
    - name: ğŸ§¹ Post-merge cleanup
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = context.payload.pull_request.head.ref;
          
          // ãƒãƒ¼ã‚¸å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          const completionMessage = `## âœ… ãƒãƒ¼ã‚¸å®Œäº†

**ğŸ‰ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${context.payload.pull_request.number} ãŒæ­£å¸¸ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼**

### ğŸ“Š æœ€çµ‚çµ±è¨ˆ
- **ãƒãƒ¼ã‚¸å…ˆ**: \`${context.payload.pull_request.base.ref}\`
- **ã‚½ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ**: \`${branchName}\`
- **ãƒãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—**: ${context.payload.pull_request.merged ? 'Merged' : 'Closed'}

### ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
- æœ¬ç•ªç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚Œã¾ã™
- ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã¾ã§ç´„5åˆ†ç¨‹åº¦ãŠå¾…ã¡ãã ã•ã„

### ğŸ§¹ ãƒ–ãƒ©ãƒ³ãƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
\`${branchName}\` ãƒ–ãƒ©ãƒ³ãƒã¯æ‰‹å‹•ã§å‰Šé™¤ã§ãã¾ã™ï¼š

\`\`\`bash
git branch -d ${branchName}
git push origin --delete ${branchName}
\`\`\`

---
*å¤‰æ›´ãŒæœ¬ç•ªç’°å¢ƒã«åæ˜ ã•ã‚Œã¾ã—ãŸï¼ ğŸš€*`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: completionMessage,
          });